generator client {
  provider        = "prisma-client"
  output          = "../lib/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm, pgcrypto, uuid_ossp]
}

// ============================================================
// ENUMS
// ============================================================

enum UnitType {
  kg
  g
  lb
  oz
  l
  ml
  gal
  each
  case_unit @map("case")
  pack
  box
  bag
  dozen
  slice
  portion
}

enum InputMethod {
  barcode
  photo
  manual
  receipt
  shopping
}

enum TransactionType {
  purchase
  adjustment
  waste
  transfer
}

enum MatchConfidence {
  high
  medium
  low
  none
}

enum ReceiptStatus {
  pending
  parsing
  review
  committed
  failed
}

enum LineItemStatus {
  matched
  suggested
  unresolved
  confirmed
  skipped
}

enum ShoppingSessionStatus {
  draft
  reconciling
  ready
  committed
  cancelled
}

enum ShoppingItemOrigin {
  staged
  receipt
}

enum ShoppingReconciliationStatus {
  pending
  exact
  quantity_mismatch
  price_mismatch
  missing_on_receipt
  extra_on_receipt
}

enum ShoppingItemResolution {
  pending
  accept_staged
  accept_receipt
  skip
}

enum FinancialTransactionType {
  income
  expense
}

enum FinancialSource {
  godaddy_pos
  uber_eats
  doordash
  shopping
  manual
}

enum SyncStatus {
  running
  success
  failed
}

enum BusinessRole {
  owner
  manager
  staff
}

enum BusinessInviteStatus {
  pending
  accepted
  revoked
  expired
}

enum IndustryType {
  restaurant
  salon
  retail
  contractor
  general
}

enum BarcodeResolutionStatus {
  resolved
  unresolved
  needs_review
}

enum BarcodeSourceProvider {
  internal_tenant_lookup
  open_food_facts
  open_beauty_facts
  upcdatabase
  upcitemdb
  manual
}

enum BarcodeResolutionEventOutcome {
  hit
  miss
  error
  throttled
}

// ============================================================
// TABLES
// ============================================================

model Category {
  id          String          @id @default(uuid())
  business_id String
  name        String
  created_at  DateTime        @default(now())
  items       InventoryItem[]
  business    Business        @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, name])
  @@index([business_id])
  @@map("categories")
}

model Supplier {
  id                String          @id @default(uuid())
  business_id       String
  name              String
  google_place_id   String?
  formatted_address String?
  latitude          Decimal?        @db.Decimal(10, 7)
  longitude         Decimal?        @db.Decimal(10, 7)
  created_at        DateTime        @default(now())
  items             InventoryItem[]
  receipts          Receipt[]
  shopping_sessions ShoppingSession[]
  price_history     ItemPriceHistory[]
  business          Business        @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, name])
  @@unique([business_id, google_place_id])
  @@index([business_id])
  @@map("suppliers")
}

model InventoryItem {
  id             String    @id @default(uuid())
  business_id    String
  name           String
  category_id    String?
  unit           UnitType  @default(each)
  units_per_case Decimal?
  default_cost   Decimal?  @db.Decimal(10, 2)
  supplier_id    String?
  par_level      Decimal?
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  category     Category?              @relation(fields: [category_id], references: [id], onDelete: SetNull)
  supplier     Supplier?              @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  barcodes     ItemBarcode[]
  aliases      ItemAlias[]
  receipt_aliases ReceiptItemAlias[]
  transactions InventoryTransaction[]
  line_items   ReceiptLineItem[]
  shopping_session_items ShoppingSessionItem[]
  price_history ItemPriceHistory[]
  business     Business               @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([category_id])
  @@index([supplier_id])
  @@map("inventory_items")
}

model ItemBarcode {
  id                String        @id @default(uuid())
  business_id       String
  inventory_item_id String
  barcode           String
  created_at        DateTime      @default(now())

  inventory_item InventoryItem @relation(fields: [inventory_item_id], references: [id], onDelete: Cascade)
  business       Business      @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, barcode])
  @@index([business_id])
  @@index([inventory_item_id])
  @@map("item_barcodes")
}

model ItemAlias {
  id                String       @id @default(uuid())
  inventory_item_id String
  alias_text        String
  source            InputMethod?
  created_at        DateTime     @default(now())

  inventory_item InventoryItem @relation(fields: [inventory_item_id], references: [id], onDelete: Cascade)

  @@unique([inventory_item_id, alias_text])
  @@index([inventory_item_id])
  @@map("item_aliases")
}

model ReceiptItemAlias {
  id                String          @id @default(uuid())
  business_id       String
  google_place_id   String
  alias_text        String
  inventory_item_id String
  confidence        MatchConfidence @default(high)
  created_at        DateTime        @default(now())

  business       Business       @relation(fields: [business_id], references: [id], onDelete: Cascade)
  inventory_item InventoryItem  @relation(fields: [inventory_item_id], references: [id], onDelete: Cascade)

  @@unique([business_id, google_place_id, alias_text])
  @@index([business_id, google_place_id])
  @@index([inventory_item_id])
  @@map("receipt_item_aliases")
}

model GlobalBarcodeCatalog {
  id                 String                  @id @default(uuid())
  barcode_normalized String                  @unique
  gtin_format        String?
  resolution_status  BarcodeResolutionStatus @default(unresolved)
  canonical_title    String?
  brand              String?
  size_text          String?
  category_hint      String?
  image_url          String?
  confidence         MatchConfidence         @default(none)
  source_provider    BarcodeSourceProvider?
  source_updated_at  DateTime?
  first_seen_at      DateTime                @default(now())
  last_seen_at       DateTime                @default(now())
  retry_after_at     DateTime?
  failure_count      Int                     @default(0)

  resolution_events BarcodeResolutionEvent[]

  @@index([resolution_status])
  @@index([retry_after_at])
  @@index([source_provider])
  @@map("global_barcode_catalog")
}

model BarcodeResolutionEvent {
  id                         String                       @id @default(uuid())
  barcode_catalog_id         String?
  barcode_normalized         String
  provider                   BarcodeSourceProvider
  outcome                    BarcodeResolutionEventOutcome
  confidence                 MatchConfidence              @default(none)
  normalized_fields_snapshot Json?
  error_code                 String?
  duration_ms                Int?
  created_at                 DateTime                     @default(now())

  barcode_catalog GlobalBarcodeCatalog? @relation(fields: [barcode_catalog_id], references: [id], onDelete: SetNull)

  @@index([barcode_catalog_id])
  @@index([barcode_normalized])
  @@index([provider, outcome])
  @@index([created_at])
  @@map("barcode_resolution_events")
}

model Receipt {
  id          String        @id @default(uuid())
  business_id String
  image_url   String?
  image_path  String?       /// Private bucket path for the original receipt photo
  raw_text    String?
  parsed_data Json?
  supplier_id String?
  status      ReceiptStatus @default(pending)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  supplier     Supplier?              @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  line_items   ReceiptLineItem[]
  transactions InventoryTransaction[]
  shopping_session ShoppingSession?
  business     Business               @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([status])
  @@map("receipts")
}

model ReceiptLineItem {
  id              String          @id @default(uuid())
  receipt_id      String
  line_number     Int
  raw_text        String
  parsed_name     String?
  quantity        Decimal?
  unit            UnitType?
  line_cost       Decimal?        @db.Decimal(10, 2)
  unit_cost       Decimal?        @db.Decimal(10, 2)
  plu_code        Int?
  organic_flag    Boolean?
  matched_item_id String?
  confidence      MatchConfidence @default(none)
  status          LineItemStatus  @default(unresolved)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt

  receipt      Receipt        @relation(fields: [receipt_id], references: [id], onDelete: Cascade)
  matched_item InventoryItem? @relation(fields: [matched_item_id], references: [id], onDelete: SetNull)
  transactions InventoryTransaction[]
  shopping_session_items ShoppingSessionItem[]

  @@index([receipt_id])
  @@index([matched_item_id])
  @@map("receipt_line_items")
}

model InventoryTransaction {
  id                   String          @id @default(uuid())
  business_id          String
  inventory_item_id    String
  transaction_type     TransactionType @default(purchase)
  quantity             Decimal
  unit                 UnitType
  unit_cost            Decimal?        @db.Decimal(10, 2)
  total_cost           Decimal?        @db.Decimal(10, 2)
  input_method         InputMethod
  source               String?
  receipt_id           String?
  receipt_line_item_id String?         @unique
  shopping_session_id  String?
  notes                String?
  raw_data             Json?
  created_at           DateTime        @default(now())

  inventory_item  InventoryItem    @relation(fields: [inventory_item_id], references: [id], onDelete: Restrict)
  receipt         Receipt?         @relation(fields: [receipt_id], references: [id], onDelete: SetNull)
  receipt_line_item ReceiptLineItem? @relation(fields: [receipt_line_item_id], references: [id], onDelete: SetNull)
  shopping_session ShoppingSession? @relation(fields: [shopping_session_id], references: [id], onDelete: SetNull)
  business        Business         @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([inventory_item_id])
  @@index([created_at(sort: Desc)])
  @@index([receipt_id])
  @@index([shopping_session_id])
  @@index([transaction_type])
  @@index([input_method])
  @@map("inventory_transactions")
}

model ShoppingSession {
  id              String                @id @default(uuid())
  business_id     String
  supplier_id     String?
  google_place_id String?
  store_name      String?
  store_address   String?
  store_lat       Decimal?              @db.Decimal(10, 7)
  store_lng       Decimal?              @db.Decimal(10, 7)
  receipt_id      String?               @unique
  status          ShoppingSessionStatus @default(draft)
  started_at      DateTime              @default(now())
  completed_at    DateTime?
  staged_subtotal Decimal?              @db.Decimal(10, 2)
  receipt_subtotal Decimal?             @db.Decimal(10, 2)
  tax_total       Decimal?              @db.Decimal(10, 2)
  receipt_total   Decimal?              @db.Decimal(10, 2)
  notes           String?
  created_at      DateTime              @default(now())
  updated_at      DateTime              @updatedAt

  supplier     Supplier?               @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  receipt      Receipt?                @relation(fields: [receipt_id], references: [id], onDelete: SetNull)
  items        ShoppingSessionItem[]
  transactions InventoryTransaction[]
  price_history ItemPriceHistory[]
  financial_transactions FinancialTransaction[]
  business     Business                @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([status])
  @@index([supplier_id])
  @@index([google_place_id])
  @@map("shopping_sessions")
}

model ShoppingSessionItem {
  id                    String                        @id @default(uuid())
  session_id            String
  inventory_item_id     String?
  receipt_line_item_id  String?
  scanned_barcode       String?
  origin                ShoppingItemOrigin           @default(staged)
  raw_name              String
  normalized_name       String
  quantity              Decimal                      @default(1)
  unit                  UnitType                     @default(each)
  staged_unit_price     Decimal?                     @db.Decimal(10, 2)
  staged_line_total     Decimal?                     @db.Decimal(10, 2)
  receipt_quantity      Decimal?
  receipt_unit_price    Decimal?                     @db.Decimal(10, 2)
  receipt_line_total    Decimal?                     @db.Decimal(10, 2)
  delta_quantity        Decimal?
  delta_price           Decimal?                     @db.Decimal(10, 2)
  reconciliation_status ShoppingReconciliationStatus @default(pending)
  resolution            ShoppingItemResolution       @default(pending)
  resolution_audit      Json?
  created_at            DateTime                     @default(now())
  updated_at            DateTime                     @updatedAt

  session      ShoppingSession  @relation(fields: [session_id], references: [id], onDelete: Cascade)
  inventory_item InventoryItem? @relation(fields: [inventory_item_id], references: [id], onDelete: SetNull)
  receipt_line  ReceiptLineItem? @relation(fields: [receipt_line_item_id], references: [id], onDelete: SetNull)

  @@index([session_id])
  @@index([inventory_item_id])
  @@index([scanned_barcode])
  @@index([reconciliation_status])
  @@map("shopping_session_items")
}

model ItemPriceHistory {
  id                  String   @id @default(uuid())
  business_id         String
  inventory_item_id   String
  supplier_id         String?
  shopping_session_id String?
  unit_cost           Decimal  @db.Decimal(10, 2)
  recorded_at         DateTime @default(now())

  inventory_item   InventoryItem    @relation(fields: [inventory_item_id], references: [id], onDelete: Cascade)
  supplier         Supplier?        @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  shopping_session ShoppingSession? @relation(fields: [shopping_session_id], references: [id], onDelete: SetNull)
  business         Business         @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([inventory_item_id, recorded_at(sort: Desc)])
  @@index([supplier_id])
  @@map("item_price_history")
}

model FinancialTransaction {
  id                  String                   @id @default(uuid())
  business_id         String
  type                FinancialTransactionType
  source              FinancialSource
  amount              Decimal                  @db.Decimal(10, 2)
  description         String?
  occurred_at         DateTime
  external_id         String?
  metadata            Json?
  shopping_session_id String?
  created_at          DateTime                 @default(now())

  shopping_session ShoppingSession? @relation(fields: [shopping_session_id], references: [id], onDelete: SetNull)
  business         Business         @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@unique([business_id, source, external_id])
  @@index([type, occurred_at(sort: Desc)])
  @@index([source, occurred_at(sort: Desc)])
  @@index([occurred_at(sort: Desc)])
  @@map("financial_transactions")
}

model ExternalSyncLog {
  id              String          @id @default(uuid())
  business_id     String
  source          FinancialSource
  status          SyncStatus
  started_at      DateTime        @default(now())
  completed_at    DateTime?
  records_fetched Int             @default(0)
  error_message   String?
  period_start    DateTime?
  period_end      DateTime?
  business        Business        @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([source, started_at(sort: Desc)])
  @@map("external_sync_logs")
}

model Contact {
  id          String   @id @default(uuid())
  business_id String
  name        String
  company     String?
  role        String?
  phone       String?
  email       String?
  website     String?
  notes       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  business Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@map("contacts")
}

model ProduceItem {
  plu_code        Int
  language_code   String
  category        String
  commodity       String
  variety         String?
  size_label      String?
  scientific_name String?
  display_name    String

  @@id([plu_code, language_code])
  @@index([display_name(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([commodity(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([variety(ops: raw("gin_trgm_ops"))], type: Gin)
  @@map("produce_items")
}

model Business {
  id             String                 @id @default(uuid())
  name           String
  industry_type  IndustryType           @default(general)
  created_at     DateTime               @default(now())
  updated_at     DateTime               @updatedAt
  memberships    UserBusiness[]
  invites        BusinessInvite[]
  modules        BusinessModule[]
  categories     Category[]
  suppliers      Supplier[]
  inventory_items InventoryItem[]
  item_barcodes  ItemBarcode[]
  receipt_item_aliases ReceiptItemAlias[]
  receipts       Receipt[]
  inventory_transactions InventoryTransaction[]
  shopping_sessions ShoppingSession[]
  item_price_history ItemPriceHistory[]
  financial_transactions FinancialTransaction[]
  external_sync_logs ExternalSyncLog[]
  contacts       Contact[]

  @@map("businesses")
}

model BusinessModule {
  id          String   @id @default(uuid())
  business_id String
  module_id   String
  enabled     Boolean  @default(true)
  config      Json?
  created_at  DateTime @default(now())
  business    Business @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, module_id])
  @@index([business_id])
  @@map("business_modules")
}

model UserBusiness {
  user_id     String
  business_id String
  role        BusinessRole @default(owner)
  created_at  DateTime     @default(now())
  business    Business     @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@id([user_id, business_id])
  @@index([business_id])
  @@map("user_businesses")
}

model BusinessInvite {
  id                 String             @id @default(uuid())
  business_id        String
  email              String
  role               BusinessRole       @default(staff)
  token              String             @unique
  invited_by_user_id String
  status             BusinessInviteStatus @default(pending)
  expires_at         DateTime
  accepted_at        DateTime?
  created_at         DateTime           @default(now())
  business           Business           @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id, status])
  @@index([email])
  @@map("business_invites")
}
